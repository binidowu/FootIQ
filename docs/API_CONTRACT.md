# FootIQ API Contract (v1.1)

This document is the **source of truth** for the integration between:
- **Node.js Gateway (Orchestrator)** and
- **Python Agent Service (Brain)**

It defines request/response envelopes, error codes, session rules, artifact handling, and replay mode.

---

## 0) Core Principles

1. **Stable JSON envelope**: Both sides speak a versioned schema.
2. **Traceability**: `trace_id` is generated by Node and propagated end-to-end.
3. **App-level errors are explicit**: Python returns a structured `status` + `error` object.
4. **Demo resilience**: Replay mode must behave identically to live mode at the contract layer.

---

## 1) Node → Python Request Schema

**Endpoint (Python):** `POST /agent/query`
**Purpose:** Node sends user query + session context + constraints.

### 1.1 Request Envelope

```json
{
  "schema_version": "1.1",
  "trace_id": "ftiq_8f2c_20260210_091530",
  "session": {
    "session_id": "user_123",
    "history": [
      {"role": "user", "content": "How is Haaland doing?"},
      {"role": "assistant", "content": "Haaland is in strong form with a 7.8 rating..."}
    ],
    "memory_summary": "User is analyzing Erling Haaland's recent form."
  },
  "query": "Why is his output dropping?",
  "constraints": {
    "data_mode": "live",
    "max_depth": "L2",
    "allow_live_fetch": true
  }
}
```

### 1.2 Field Definitions

- `schema_version` (string, required) — Current: `"1.1"`
- `trace_id` (string, required) — Generated by Node. Must be unique per request.
- `session.session_id` (string, required)
- `session.history` (array, required) — **Node MUST cap to max 10 messages** (rolling window). Roles: `"user" | "assistant"`
- `session.memory_summary` (string or null, optional) — First request may omit or set to `null`. Max length: **500 chars** (Python may truncate when returning).
- `query` (string, required) — Must be non-empty after trimming.
- `constraints.data_mode` (string, required) — `"live"`: call SportApiPro + cache. `"replay"`: load fixtures only.
- `constraints.max_depth` (string, required) — `"L1"`: summary-only tools. `"L2"`: summary + deep lineup tools. `"auto"`: L2 + RAG permitted (agent decides).
- `constraints.allow_live_fetch` (boolean, required) — `false` = cache-only (no upstream HTTP calls).

### 1.3 Request Validation Rules (Python)

If request fails validation, Python returns an envelope with `status:"error"`:

| Condition | Error Code |
|-----------|-----------|
| Missing `trace_id` | `INVALID_REQUEST` |
| Missing `session.session_id` | `INVALID_REQUEST` |
| Empty `query` | `INVALID_REQUEST` |
| Unsupported `schema_version` | `SCHEMA_MISMATCH` |
| `history` > 10 entries | Python truncates + emits `HISTORY_TRUNCATED` warning |

---

## 2) Python → Node Response Schema

### 2.1 Response Envelope (Success)

```json
{
  "schema_version": "1.1",
  "trace_id": "ftiq_8f2c_20260210_091530",
  "status": "ok",
  "session": {
    "session_id": "user_123",
    "updated_summary": "Discussing Bukayo Saka's recent xG dip and potential tactical causes."
  },
  "output": {
    "answer": "Saka is averaging a 7.8 rating over his last 5 matches, but his xG trend has dipped...",
    "artifacts": [
      {
        "type": "plot",
        "url": "/static/plots/ftiq_8f2c_form.png",
        "label": "Rolling 5-Game Form"
      },
      {
        "type": "stat_table",
        "data": [
          {"game": "vs LIV", "minutes": 90, "rating": 7.6, "goals": 0, "assists": 1},
          {"game": "vs CHE", "minutes": 85, "rating": 7.9, "goals": 1, "assists": 0}
        ],
        "label": "Recent Match History"
      }
    ],
    "sources": [
      {"id": "kb_42", "title": "Tactical Analysis: Arsenal's Right Flank", "relevance": 0.92}
    ]
  },
  "metadata": {
    "data_depth": "L2",
    "reasoning_mode": "SYNTHESIS",
    "tools_invoked": [
      {"tool": "search_entity", "duration_ms": 110, "cache_hit": true},
      {"tool": "get_athlete_games", "duration_ms": 240, "cache_hit": true, "ttl_remaining_s": 1800},
      {"tool": "calculate_form", "duration_ms": 45, "cache_hit": false}
    ],
    "usage": {
      "total_duration_ms": 840,
      "rate_limit_remaining": 482
    }
  },
  "warnings": [],
  "suggestions": ["Compare to Phil Foden", "Show heatmap vs Liverpool"],
  "error": null
}
```

### 2.2 Response Envelope (Error)

```json
{
  "schema_version": "1.1",
  "trace_id": "ftiq_8f2c_20260210_091530",
  "status": "error",
  "session": {
    "session_id": "user_123",
    "updated_summary": "Attempted entity search; no confident match found."
  },
  "output": {
    "answer": "I couldn't find that player. Did you mean one of these?",
    "artifacts": [],
    "sources": []
  },
  "metadata": {
    "data_depth": "L1",
    "reasoning_mode": "DATA_ONLY",
    "tools_invoked": [
      {"tool": "search_entity", "duration_ms": 95, "cache_hit": false}
    ],
    "usage": {
      "total_duration_ms": 160,
      "rate_limit_remaining": 480
    }
  },
  "warnings": [],
  "suggestions": ["Try a different spelling", "Search with club name"],
  "error": {
    "code": "PLAYER_NOT_FOUND",
    "message": "No results for 'Messsi'.",
    "options": [
      {"label": "Lionel Messi (Inter Miami)", "athlete_id": "ath_123"},
      {"label": "Lionel Messi (Argentina)", "athlete_id": "ath_123"}
    ],
    "retry_after_s": null
  }
}
```

### 2.3 Required Response Fields

Every Python response MUST include:

`schema_version`, `trace_id`, `status`, `session.session_id`, `output.answer`, `metadata.data_depth`, `metadata.reasoning_mode`, `metadata.tools_invoked`, `warnings` (may be `[]`), `suggestions` (may be `[]`), `error` (`null` on ok, object on error).

### 2.4 Metadata: Split Dimensions

- `metadata.data_depth` (required): `"L1" | "L2"` — What data granularity was used.
- `metadata.reasoning_mode` (required): `"DATA_ONLY" | "RAG" | "SYNTHESIS"` — How the answer was constructed.

These are **independent dimensions**. Example: `data_depth:"L2"` + `reasoning_mode:"RAG"` is valid.

---

## 3) Warnings (Structured)

Warnings MUST be structured objects:

```json
"warnings": [
  {
    "code": "DATA_MODE_REPLAY",
    "message": "DATA_MODE=replay active. Using static fixtures.",
    "details": {"fixture": "athletes_games__ath_123__last5.json"}
  },
  {
    "code": "BASELINE_MISSING",
    "message": "No league baseline for xG (Bundesliga). Z-score disabled.",
    "details": {"metric": "xg", "fallback": "disabled"}
  }
]
```

**Warning codes:**

| Code | Meaning |
|------|---------|
| `DATA_MODE_REPLAY` | Replay mode is active |
| `CACHE_ONLY_MODE` | `allow_live_fetch` was false |
| `INSUFFICIENT_GAMES` | Fewer than 3 games available in the requested window |
| `INSUFFICIENT_MINUTES` | Total minutes below per-90 threshold (< 90 min) |
| `METRIC_UNAVAILABLE` | Requested metric not available for player |
| `NORMALIZATION_GAP` | Unknown stat type ID encountered; metric skipped (non-fatal) |
| `BASELINE_MISSING` | Z-score baseline not found or unusable (`std==0`, low `n`) |
| `USED_CACHED_DATA` | Stale but valid cached data was used |
| `HISTORY_TRUNCATED` | History exceeded 10 entries; truncated |

---

## 4) Error Codes & Failure Modes

When `status:"error"`, `error.code` must be one of:

| Code | Trigger | Node/UI Behavior |
|------|---------|------------------|
| `INVALID_REQUEST` | Request fails validation | Generic "bad request" + log payload |
| `SCHEMA_MISMATCH` | Unsupported `schema_version` | Prompt upgrade / fallback |
| `INSUFFICIENT_CONTEXT` | Pronouns on cold start | Ask clarifying question |
| `PLAYER_NOT_FOUND` | Search returns 0 | Suggest alternatives |
| `AMBIGUOUS_ENTITY` | Multiple high-confidence matches | Show options list |
| `INSUFFICIENT_DATA` | <3 games in window | Offer larger window |
| `RATE_LIMIT_BACKOFF` | Rate limit near/at 0 | Offer cached-only / `retry_after_s` |
| `UPSTREAM_TIMEOUT` | Upstream API timeout | Offer replay / cached-only |
| `UPSTREAM_DOWN` | Upstream unreachable | Offer replay / cached-only |
| `ARTIFACT_WRITE_FAILED` | Plot write failed | Answer without artifact + warning |

> [!NOTE]
> `NORMALIZATION_GAP` is a **warning-only** condition (see Section 3). An unmapped stat ID produces partial results with `status:"ok"`, not an error.

**Error object shape:**

```json
"error": {
  "code": "AMBIGUOUS_ENTITY",
  "message": "I found multiple matches for 'Saka'.",
  "options": [...],
  "retry_after_s": null
}
```

---

## 5) Suggestions Policy

- `suggestions`: array of strings, **max 3**.
- May be empty on errors.
- Source: LLM-generated or rule-based.
- Must be phrased as user-actionable next queries.

---

## 6) Session Lifecycle Policy (Node-Owned)

Node is the source of truth for session persistence.

| Parameter | Value |
|-----------|-------|
| Storage | In-memory `Map<session_id, SessionData>` |
| Expiry | 30 minutes inactivity |
| Cleanup interval | Every 5 minutes |
| Max history | 10 messages (rolling window) |
| Memory summary | Store `updated_summary` from Python; send as `memory_summary` |

**Cold start rule:** If `history` is empty AND query is ambiguous (pronouns, "compare them"), Node sends request normally — Python returns `INSUFFICIENT_CONTEXT`.

**Memory summary rules:**
- First request: `memory_summary` is `null` or empty string.
- Python returns `updated_summary` after every response.
- Node stores it and sends it back on the next request.
- Max length: 500 characters (Python truncates if needed).

---

## 7) Artifact & Static Path Rules

### 7.1 Shared Folder

- Python writes to: `node_gateway/public/plots/`
- Node serves: `GET /static/plots/<filename>` → `public/plots/<filename>`

### 7.2 Naming Convention

`{trace_id}_{tool}.png`

Example: `ftiq_8f2c_form.png`

### 7.3 Cleanup Policy (Node)

- Cron: every 60 minutes
- Delete files older than 2 hours

### 7.4 Artifact Types in Response

| Type | Fields |
|------|--------|
| `plot` | `type`, `url`, `label` |
| `heatmap` | `type`, `url`, `label` |
| `stat_table` | `type`, `data`, `label` |

---

## 8) Replay Mode

### 8.1 Behavior

When `constraints.data_mode: "replay"`:
- Python MUST NOT call SportApiPro.
- Python loads fixtures from: `python_agent/tests/fixtures/`
- Python MUST include warning `DATA_MODE_REPLAY`.

### 8.2 Fixture Naming

- `search_entity__<query>.json`
- `athletes_games__<athleteId>__last<N>.json`
- `athlete_lineup__<athleteId>__<gameId>.json`
- `kb_search__<query_hash>.json` (optional)

### 8.3 Minimum Fixture Set (Demo)

1. Cold start (surface stats)
2. Disambiguation (ambiguous entity)
3. Synthesis (L2 + RAG)
4. Rate-limit / upstream failure simulation

---

## 9) HTTP Status Code Policy

- Python ALWAYS returns **HTTP 200** for both ok and error envelopes.
- Use `status:"error"` + structured `error` object for application failures.
- Node may translate to HTTP status codes externally if desired (optional).

---

## 10) Schema Compatibility

- `schema_version` higher than supported → `SCHEMA_MISMATCH` error.
- `schema_version` lower than supported → Best-effort parse + `SCHEMA_VERSION_UPLEVEL` warning.

---

## Quick Reference

**Request (Node → Python):** `schema_version`, `trace_id`, `session`, `query`, `constraints`

**Response (Python → Node):** `schema_version`, `trace_id`, `status`, `session`, `output`, `metadata`, `warnings`, `suggestions`, `error`
